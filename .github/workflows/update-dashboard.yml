name: ğŸ”„ Update Branch Dashboard

on:
  # ç•¶æ¨é€åˆ°ä»»ä½•åˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches:
      - '**'
  
  # ç•¶å‰µå»ºæ–°åˆ†æ”¯æˆ–æ¨™ç±¤æ™‚è§¸ç™¼
  create:
  
  # ç•¶åˆªé™¤åˆ†æ”¯æˆ–æ¨™ç±¤æ™‚è§¸ç™¼
  delete:
  
  # å®šæ™‚åŸ·è¡Œï¼ˆæ¯ 6 å°æ™‚ä¸€æ¬¡ï¼‰
  schedule:
    - cron: '0 */6 * * *'  # UTC æ™‚é–“ï¼š00:00, 06:00, 12:00, 18:00
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      branch_limit:
        description: 'è¦é¡¯ç¤ºçš„åˆ†æ”¯æ•¸é‡'
        required: false
        default: '15'

jobs:
  update-dashboard:
    name: ğŸ“Š Update Dashboard
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾†æ›´æ–° README
      
    steps:
      # æ­¥é©Ÿ 1: æª¢å‡ºå€‰åº«
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´çš„ git æ­·å²
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥é©Ÿ 2: è¨­ç½® Python ç’°å¢ƒ
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # ç·©å­˜ pip ä¾è³´
      
      # æ­¥é©Ÿ 3: å®‰è£ä¾è³´
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£ Python ä¾è³´..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… ä¾è³´å®‰è£å®Œæˆ"
      
      # æ­¥é©Ÿ 4: é©—è­‰å®‰è£
      - name: ğŸ” Verify Installation
        run: |
          echo "ğŸ” é©—è­‰ Python ç’°å¢ƒ..."
          python --version
          echo ""
          echo "ğŸ“¦ å·²å®‰è£çš„å¥—ä»¶:"
          pip list
          echo ""
          echo "âœ… é©—è­‰å®Œæˆ"
      
      # æ­¥é©Ÿ 5: åŸ·è¡Œæ›´æ–°è…³æœ¬
      - name: ğŸ”„ Run Dashboard Update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          echo "ğŸš€ é–‹å§‹æ›´æ–°å„€è¡¨æ¿..."
          python update_dashboard.py
          echo "âœ… æ›´æ–°è…³æœ¬åŸ·è¡Œå®Œæˆ"
      
      # æ­¥é©Ÿ 6: æª¢æŸ¥è®Šæ›´
      - name: ğŸ“Š Check for Changes
        id: verify-diff
        run: |
          echo "ğŸ” æª¢æŸ¥ README.md æ˜¯å¦æœ‰è®Šæ›´..."
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  æ²’æœ‰æª¢æ¸¬åˆ°è®Šæ›´"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… æª¢æ¸¬åˆ°è®Šæ›´"
            echo ""
            echo "ğŸ“ è®Šæ›´å…§å®¹:"
            git diff README.md
          fi
      
      # æ­¥é©Ÿ 7: æäº¤ä¸¦æ¨é€è®Šæ›´
      - name: ğŸ’¾ Commit and Push Changes
        if: steps.verify-diff.outputs.changed == 'true'
        run: |
          echo "ğŸ’¾ æ­£åœ¨æäº¤è®Šæ›´..."
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add README.md
          
          git commit -m "ğŸ“Š Update branch dashboard [skip ci]
          
          ğŸ¤– Auto-generated by GitHub Actions
          ğŸ“… $(date +'%Y-%m-%d %H:%M:%S UTC')
          ğŸ”— Workflow: ${{ github.workflow }}
          ğŸ“ Run: #${{ github.run_number }}
          ğŸ¯ Trigger: ${{ github.event_name }}"
          
          git push
          echo "âœ… è®Šæ›´å·²æ¨é€"
      
      # æ­¥é©Ÿ 8: æˆåŠŸé€šçŸ¥
      - name: âœ… Success Notification
        if: steps.verify-diff.outputs.changed == 'true'
        run: |
          echo "::notice title=Dashboard Updated::å„€è¡¨æ¿å·²æˆåŠŸæ›´æ–°! ğŸ‰"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âœ… Dashboard Updated Successfully!   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Updated at: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow: ${{ github.workflow }}"
          echo "ğŸ“ Run: #${{ github.run_number }}"
      
      # æ­¥é©Ÿ 9: ç„¡è®Šæ›´é€šçŸ¥
      - name: â„¹ï¸ No Changes Notification
        if: steps.verify-diff.outputs.changed != 'true'
        run: |
          echo "::notice title=No Changes::å„€è¡¨æ¿å·²æ˜¯æœ€æ–°ç‹€æ…‹ âœ¨"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   â„¹ï¸  Dashboard is Up to Date!        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Checked at: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow: ${{ github.workflow }}"
          echo "ğŸ“ Run: #${{ github.run_number }}"
